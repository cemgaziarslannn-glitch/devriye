
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Denetleme Sistemi</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>


<style>
/* ===== GENEL ===== */
body{
 margin:0;
 font-family:'Segoe UI',system-ui;
 background:radial-gradient(circle at top,#111a3a,#050914);
 color:#fff;
}

section{
 padding:24px 20px;
 max-width:420px;
 margin:auto;
 animation:fade .3s ease;
}

@keyframes fade{
 from{opacity:0;transform:translateY(10px)}
 to{opacity:1;transform:none}
}

/* ===== FORM ===== */
input,select{
 width:100%;
 padding:14px 16px;
 margin-top:12px;
 border-radius:14px;
 background:#0f1735;
 border:1px solid #ffffff22;
 color:#fff;
 font-size:14px;
 outline:none;
}

input:focus,select:focus{
 border-color:#00e5ff;
 box-shadow:0 0 0 2px #00e5ff22;
}

/* ===== BUTON ===== */
button{
 width:100%;
 padding:14px;
 margin-top:14px;
 border-radius:16px;
 border:none;
 font-size:15px;
 font-weight:700;
 cursor:pointer;
 transition:.2s;
 background:linear-gradient(135deg,#00e5ff,#6a5cff);
 color:#000;
 box-shadow:0 10px 30px #00e5ff33;
}

button:hover{
 transform:translateY(-1px);
 box-shadow:0 14px 40px #00e5ff55;
}

button:active{
 transform:scale(.98);
}

/* ===== LÄ°STE ===== */
.list-item{
 background:linear-gradient(135deg,#1b2445,#202c5a);
 padding:16px 18px;
 border-radius:20px;
 margin:12px 0;
 display:flex;
 align-items:center;
 gap:10px;
 box-shadow:0 10px 30px rgba(0,0,0,.25);
}

/* ===== PERSONEL ===== */
.guard-name{
 font-weight:600;
 font-size:14px;
}

/* ===== SAÄ AKSÄ°YON ===== */
.right-actions{
 display:flex;
 align-items:center;
 gap:8px;
 margin-left:auto;
}

/* ===== ARA BUTONU ===== */
.call-btn{
 background:rgba(0,229,255,.15);
 color:#00e5ff;
 padding:6px 12px;
 border-radius:20px;
 font-size:12px;
 font-weight:700;
 border:1px solid #00e5ff55;
 transition:.2s;
}

.call-btn:hover{
 background:#00e5ff;
 color:#000;
}

/* ===== BADGE ===== */
.badge{
 background:linear-gradient(135deg,#00e5ff,#6a5cff);
 color:#000;
 padding:4px 10px;
 border-radius:20px;
 font-size:11px;
 font-weight:800;
 box-shadow:0 0 10px #00e5ff88;
}

/* ===== BAÅLIKLAR ===== */
h2,h3{
 margin:0 0 10px;
 letter-spacing:.3px;
}

h2{
 font-size:20px;
 color:#00e5ff;
}

h3{
 font-size:15px;
 color:#8fdfff;
}

/* ===== KART ===== */
.card{
 background:linear-gradient(135deg,#1b2445,#202c5a);
 padding:22px;
 border-radius:22px;
 box-shadow:0 20px 50px rgba(0,0,0,.4);
}

.row{
 display:flex;
 justify-content:space-between;
 margin:8px 0;
 font-size:14px;
}

/* ===== ALERT ===== */
.alert-box{
 background:linear-gradient(135deg,#1b2445,#202c5a);
 padding:26px;
 border-radius:22px;
 box-shadow:0 30px 80px rgba(0,0,0,.6);
}
#qr-reader{
 border-radius:20px;
 overflow:hidden;
 box-shadow:0 20px 50px rgba(0,0,0,.5);
}
/* ===== KIMLIK SÃœRESÄ° UYARI ===== */
.expiry-warning{
 background:linear-gradient(135deg,#ff3b3b,#b30000);
 padding:12px 16px;
 border-radius:14px;
 font-size:14px;
 font-weight:800;
 margin-top:14px;
 color:#fff;
 text-align:center;
 box-shadow:
  0 0 15px rgba(255,0,0,.8),
  inset 0 0 10px rgba(0,0,0,.4);
 animation:pulseRed 1.2s infinite;
 transform:translateZ(0);
}

/* 3D kÄ±rmÄ±zÄ± yanÄ±p sÃ¶nme */
@keyframes pulseRed{
 0%{
  box-shadow:0 0 8px rgba(255,0,0,.4);
  transform:scale(1);
 }
 50%{
  box-shadow:0 0 30px rgba(255,0,0,1);
  transform:scale(1.03);
 }
 100%{
  box-shadow:0 0 8px rgba(255,0,0,.4);
  transform:scale(1);
 }
}
.hidden{display:none !important}

</style>
</head>

<body>

<section id="projectPage">
<h2>ğŸ“ Proje SeÃ§</h2>
<select id="projectSelect"></select>
<button onclick="selectProject()">Devam</button>
</section>

<section id="listPage" class="hidden">
<h2 id="projectTitle"></h2>

<div id="lastPatrolInfo" class="last-patrol"></div>

<h3 id="guardTitle" style="margin:14px 0 8px;font-size:15px;color:#8fdfff">
 ğŸ“Œ Projedeki Personeller
</h3>

<div id="guardList"></div>
<button onclick="backToProject()">â¬… Proje SeÃ§imine DÃ¶n</button>
<button onclick="startPatrol()">ğŸš€ Denetleme BaÅŸlat</button>
<button onclick="finishPatrol()">ğŸ Denetlemeyi Bitir</button>

</section>

<section id="qrPage" class="hidden">
<h3>QR Okut</h3>
<button
 onclick="openManual()"
 style="
  width:auto;
  float:right;
  padding:8px 14px;
  font-size:12px;
  margin-top:-34px
 "
>
 ğŸ§ Manuel Personel Tara
</button>


<div id="qr-reader" style="width:300px"></div>

<button onclick="toggleFlash()">ğŸ”¦ Flash AÃ§ / Kapat</button>
<button onclick="refocusCamera()">ğŸ¯ Odakla</button>

</section>

<section id="manualPage" class="hidden">
<h3>ğŸ§ Manuel Personel Tara</h3>

<input
 id="manualTc"
 placeholder="TC Kimlik No"
 maxlength="11"
 inputmode="numeric"
/>

<button onclick="manualSearch()">Ara</button>
<button onclick="backToQr()">â¬… QR Okutmaya DÃ¶n</button>
</section>

<section id="requiredPage" class="hidden">
<h3>Zorunlu Bilgiler</h3>
<input id="telefon" placeholder="Telefon">
<select id="kimlikTuru">
<option value="">Kimlik TÃ¼rÃ¼</option>
<option>SilahlÄ±</option>
<option>SilahsÄ±z</option>
</select>
<input type="date" id="kimlikGecerlilik">
<button onclick="saveRequired()">Kaydet</button>
</section>

<section id="alreadyPage" class="hidden">

<h3>âš ï¸ Bu personel denetlendi</h3>
<p id="oldInfo"></p>
<button onclick="mode='new';showCard()">â• Yeni Denetim</button>
<button onclick="mode='update';showCard()">ğŸ”„ Mevcut Denetimi GÃ¼ncelle</button>
</section>

<section id="cardPage" class="hidden">
<div class="card">

<h2 id="ad"></h2>
<!-- PROFÄ°L FOTO ALANI -->
<div id="photoWrapper"
 onclick="openPhotoOptions()"
 style="
  width:120px;
  height:120px;
  border-radius:12px;
  margin:12px auto;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#0f1735;
  border:2px dashed #00e5ff88;
  cursor:pointer;
  position:relative;
 ">

 <img id="guardPhoto"
  style="
   width:100%;
   height:100%;
   border-radius:12px;
   object-fit:contain;
   display:none;
  ">

 <span id="photoPlus"
  style="font-size:42px;color:#00e5ff">+</span>

</div>





<div class="row"><span>TC</span><span id="tc"></span></div>
<div class="row"><span>Kimlik</span><span id="kimlik"></span></div>
<div class="row"><span>GeÃ§erlilik</span><span id="gecerlilik"></span></div>
<div id="expiryInfo"></div>



<button onclick="saveInspection('gorevi_basinda')">âœ… GÃ¶revi BaÅŸÄ±nda</button>
<button onclick="openUygunsuz()">âš ï¸ Uygunsuz</button>
<div id="uygunsuzPanel" class="hidden">

 <select id="uygunsuzSebep">
 <h4 style="margin:0 0 10px;color:#ff5a5a">
 âš ï¸ Uygunsuzluk DetayÄ±
</h4>

  <option value="">Uygunsuzluk sebebi seÃ§</option>
  <option>Uyuyor</option>
  <option>KÄ±lÄ±k kÄ±yafet</option>
  <option>TÄ±raÅŸ olmamÄ±ÅŸ</option>
  <option>KimliÄŸi yok</option>
  <option>GÃ¶rev yerinde deÄŸildi</option>
  <option value="diger">DiÄŸer</option>
 </select>

 <input
  id="uygunsuzDiger"
  class="hidden"
  placeholder="DiÄŸer sebebi yaz"
 />

 <button onclick="saveUygunsuz()">Kaydet</button>

</div>

</div>
</section>

<script>

firebase.initializeApp({
 apiKey:"AIzaSyCye0QlekBFonTxfeBIlhLc9ia-mleyfUM",
 authDomain:"denetleme-4d3d9.firebaseapp.com",
 databaseURL:"https://denetleme-4d3d9-default-rtdb.firebaseio.com",
 projectId:"denetleme-4d3d9"
});
const db=firebase.database();

let proje="", aktifDevriyeId=null, tcNo="", guard={}, mevcutDenetimId=null, mode="new";
let qrInstance = null;
let flashOn = false;


/* PROJELER */
db.ref("projects").once("value",s=>{
 projectSelect.innerHTML="<option value=''>SeÃ§</option>";
 s.forEach(p=>{
  projectSelect.innerHTML+=`<option value="${p.key}">${p.val().projectName}</option>`;
 });
});

/* SAYFA YENÄ°LENÄ°RSE DEVAM */
window.onload=()=>{
 const p=localStorage.getItem("proje");
 const d=localStorage.getItem("devriye");

 if(!p){
  localStorage.clear();
  return;
 }

 proje=p;
 aktifDevriyeId=d || null;

 projectPage.classList.add("hidden");
 listPage.classList.remove("hidden");

 loadList();
 loadLastPatrolInfo();
};
function loadLastPatrolInfo(){

 db.ref(`projects/${proje}`).once("value", pSnap =>{

  if(!pSnap.exists()) return;

  const projeAdi = pSnap.val().projectName;
  const lastEnd = pSnap.val().lastPatrolEnd;

  if(!lastEnd){
   lastPatrolInfo.innerHTML = `
    <div>
     <b>ğŸ“ ${projeAdi}</b><br>
     ğŸš« HenÃ¼z denetlenmedi
    </div>
   `;
   return;
  }

  lastPatrolInfo.innerHTML = `
   <div>
    <b>ğŸ“ ${projeAdi}</b><br>
    ğŸ•’ Son denetim:
    <span class="time">${timeAgo(lastEnd)}</span>
    Ã¶nce
   </div>
  `;
 });
}




function showNoPatrol(){
 lastPatrolInfo.innerHTML = `
  <div>
   <b>ğŸ“ ${projectTitle.innerText}</b><br>
   ğŸš« HenÃ¼z denetlenmedi
  </div>
 `;
}


function selectProject(){

 if(!projectSelect.value){
  alert("LÃ¼tfen proje seÃ§");
  return;
 }

 proje=projectSelect.value;
 projectPage.classList.add("hidden");
 listPage.classList.remove("hidden");

 db.ref(`projects/${proje}`).once("value",s=>{
  projectTitle.innerText=s.val().projectName;
 });

 loadList();
  loadLastPatrolInfo();
  }



 


function loadList(){
 guardList.innerHTML = "";

 db.ref(`projects/${proje}/guards`).once("value", guards=>{
  guards.forEach(g=>{

   if(!aktifDevriyeId){
    guardList.innerHTML += `
     <div class="list-item">
      <span class="guard-name">ğŸ‘® ${g.val().adSoyad}</span>
      <div class="right-actions">
       <button class="call-btn" onclick="callGuard('${g.key}')">
        ğŸ“ Ara
       </button>
      </div>
     </div>
    `;
    return;
   }

   db.ref(`denetimler/${proje}/${g.key}`)
    .orderByChild("devriyeId")
    .equalTo(aktifDevriyeId)
    .once("value", d=>{

     guardList.innerHTML += `
      <div class="list-item">
       <span class="guard-name">ğŸ‘® ${g.val().adSoyad}</span>
       <div class="right-actions">
        ${d.exists() ? '<span class="badge">DENETLENDÄ°</span>' : ''}
        <button class="call-btn" onclick="callGuard('${g.key}')">
         ğŸ“ Ara
        </button>
       </div>
      </div>
     `;
    });

  });
 });
}

function timeAgo(ms){
 const diff = Date.now() - ms;
 const dk = Math.floor(diff / 60000);
 const saat = Math.floor(dk / 60);
 const gun = Math.floor(saat / 24);

 if(gun > 0) return `${gun} gÃ¼n ${saat % 24} saat ${dk % 60} dakika`;
 if(saat > 0) return `${saat} saat ${dk % 60} dakika`;
 return `${dk} dakika`;
}



/* DEVRIYE */
function startPatrol(){
 // QR nesnesi burada oluÅŸturulmalÄ±
qrInstance = new Html5Qrcode("qr-reader");

 if(!aktifDevriyeId){
  aktifDevriyeId=db.ref(`devriyeler/${proje}`).push({
   baslangic:Date.now(),durum:"aktif"
  }).key;
  localStorage.setItem("proje",proje);
  localStorage.setItem("devriye",aktifDevriyeId);
 }
 listPage.classList.add("hidden");
 qrPage.classList.remove("hidden");

qrInstance.start({facingMode:"environment"},{fps:10,qrbox:250},t=>{
tcNo=t;
qrInstance.stop();
checkGuard();
 });
}
/* QR KONTROL */
function checkGuard(){
 if(tcNo.length !== 11){
showAlert({ title:"GeÃ§ersiz QR", message:"Okutulan veri geÃ§erli bir TC deÄŸil", buttons:[{text:"Tamam"}] });
  return;
 }
 db.ref(`projects/${proje}/guards/${tcNo}`).once("value",g=>{
  if(!g.exists()){showAlert({
 title: "Personel BulunamadÄ±",
 message: "Okutulan QR sistemde kayÄ±tlÄ± deÄŸil",
 buttons: [
  {
   text: "Tamam",
   onClick: () => {
    qrPage.classList.add("hidden");
    listPage.classList.remove("hidden");
   }
  }
 ]
});

return;}
  guard=g.val();

  if(!guard.telefon||!guard.kimlikTuru||!guard.kimlikGecerlilik){
   qrPage.classList.add("hidden");
   requiredPage.classList.remove("hidden");
   return;
  }

  db.ref(`denetimler/${proje}/${tcNo}`)
   .orderByChild("devriyeId")
   .equalTo(aktifDevriyeId)
   .limitToLast(1)
   .once("value",d=>{
    qrPage.classList.add("hidden");
    if(d.exists()){
     d.forEach(x=>{
      mevcutDenetimId=x.key;
      oldInfo.innerHTML=`${new Date(x.val().tarih).toLocaleString("tr-TR")}<br>${x.val().durum}`;
     });
     alreadyPage.classList.remove("hidden");
    }else showCard();
	const expiry = checkKimlikExpiry(guard.kimlikGecerlilik);

if(expiry.danger){
 expiryInfo.innerHTML = `
  <div class="expiry-warning">
   ğŸš¨ ${expiry.text}
  </div>
 `;
}else{
 expiryInfo.innerHTML = `
  <div style="
   margin-top:12px;
   padding:10px;
   border-radius:12px;
   background:linear-gradient(135deg,#1e2a55,#25346b);
   box-shadow:0 0 12px rgba(0,229,255,.4);
   font-size:13px;
  ">
   ${expiry.text}
  </div>
 `;
}


   });
 });
}

/* ZORUNLU */
function saveRequired(){
 if(!telefon.value||!kimlikTuru.value||!kimlikGecerlilik.value){
  showAlert({ title:"Eksik Bilgi", message:"LÃ¼tfen tÃ¼m alanlarÄ± doldur", buttons:[{text:"Tamam"}] });
  return;
 }

 const yeniKimlikTuru = kimlikTuru.value;
 const yeniGecerlilik = kimlikGecerlilik.value;
 const yeniTelefon = telefon.value;

 db.ref(`projects/${proje}/guards/${tcNo}`).update({
  telefon: yeniTelefon,
  kimlikTuru: yeniKimlikTuru,
  kimlikGecerlilik: yeniGecerlilik
 }).then(()=>{

  // ğŸ”¥ KRÄ°TÄ°K DÃœZELTME â€” guard objesini GÃœNCELLE
  guard.telefon = yeniTelefon;
  guard.kimlikTuru = yeniKimlikTuru;
  guard.kimlikGecerlilik = yeniGecerlilik;

  requiredPage.classList.add("hidden");
  showCard();
 });
}


function showCard(){
 alreadyPage.classList.add("hidden");
 cardPage.classList.remove("hidden");

 ad.innerText = guard.adSoyad;
 tc.innerText = guard.tc;
 kimlik.innerText = guard.kimlikTuru;
 gecerlilik.innerText = guard.kimlikGecerlilik;

 if(guard.photoBase64){
  guardPhoto.src = guard.photoBase64;
  guardPhoto.style.display = "block";
  photoPlus.style.display = "none";
 }else{
  guardPhoto.style.display = "none";
  photoPlus.style.display = "block";
  photoWrapper.style.border = guard.photoBase64
 ? "none"
 : "2px dashed #00e5ff88";

photoWrapper.style.pointerEvents = "auto";

 }

 photoWrapper.style.border = guard.photoBase64
  ? "none"
  : "2px dashed #00e5ff88";
}



function saveInspection(durum, detay=null){

 let ref;

 if(mode === "update" && mevcutDenetimId){
  ref = db.ref(`denetimler/${proje}/${tcNo}/${mevcutDenetimId}`);
 }else{
  ref = db.ref(`denetimler/${proje}/${tcNo}`).push();
 }

 const data = {
  durum: durum,
  tarih: Date.now(),
  devriyeId: aktifDevriyeId
 };

 if(detay){
  data.detay = detay;
 }

 // ğŸ”¥ ESKÄ° UYGUNSUZ DETAYI TEMÄ°ZLE
 if(durum === "gorevi_basinda"){
  ref.child("detay").remove();
 }

 ref.update(data);

 cardPage.classList.add("hidden");
 listPage.classList.remove("hidden");
 loadList();

 mode="new";
 mevcutDenetimId=null;
 tcNo="";
 uygunsuzPanel.classList.add("hidden");
 uygunsuzSebep.value="";
 uygunsuzDiger.value="";
 uygunsuzDiger.classList.add("hidden");
}




/* BITIR */
function finishPatrol(){

 // â— DEVRIYE BAÅLAMADIYSA
 if(!aktifDevriyeId){
showAlert({ title:"Denetleme Yok", message:"BaÅŸlamadan denetleme bitirilemez", buttons:[{text:"Tamam"}] });
  return;
 }

showAlert({
 title:"Denetleme Bitirilsin mi?",
 message:"Devam edersen denetleme kapatÄ±lacak",
 buttons:[
  { text:"Ä°ptal" },
  { text:"Evet, Bitir", onClick:()=>{
db.ref(`devriyeler/${proje}/${aktifDevriyeId}`)
 .update({
  durum:"bitti",
  bitis: Date.now()
 })
 .then(()=>{

  return db.ref(`projects/${proje}`).update({
   lastPatrolEnd: Date.now()
  });

 })
 .then(()=>{

  localStorage.clear();
  location.reload();

 });

  }}
 ]
});


}
function showAlert({title="UyarÄ±", message="", buttons=[]}){
 alertTitle.innerText = title;
 alertMessage.innerText = message;
 alertActions.innerHTML = "";

 buttons.forEach(b=>{
  const btn=document.createElement("button");
  btn.innerText=b.text;
  btn.onclick=()=>{
   closeAlert();
   if(b.onClick) b.onClick();
  };
  alertActions.appendChild(btn);
 });

 appAlert.classList.remove("hidden");
}

function closeAlert(){
 appAlert.classList.add("hidden");
}
function checkKimlikExpiry(tarihStr){
 const today = new Date();
 const expiry = new Date(tarihStr);

 const diffMs = expiry - today;
 const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
 const diffMonths = Math.floor(diffDays / 30);

 if(diffDays <= 0){
  return {
   danger:true,
   text:"âŒ Kimlik sÃ¼resi DOLMUÅ"
  };
 }

 if(diffMonths < 6){
  return {
   danger:true,
   text:`âš ï¸ Kimlik sÃ¼resinin bitmesine ${diffMonths} ay ${diffDays % 30} gÃ¼n kaldÄ±`
  };
 }

 return {
  danger:false,
  text:`âœ… Kimlik geÃ§erli (${diffMonths} ay ${diffDays % 30} gÃ¼n kaldÄ±)`
 };
}
function openUygunsuz(){
 uygunsuzPanel.classList.remove("hidden");
 uygunsuzSebep.focus();
}


uygunsuzSebep.onchange = ()=>{
 if(uygunsuzSebep.value === "diger"){
  uygunsuzDiger.classList.remove("hidden");
 }else{
  uygunsuzDiger.classList.add("hidden");
  uygunsuzDiger.value = "";
 }
};

function saveUygunsuz(){
 if(!uygunsuzSebep.value){
  showAlert({
   title:"Eksik SeÃ§im",
   message:"Uygunsuzluk sebebi seÃ§",
   buttons:[{text:"Tamam"}]
  });
  return;
 }

 let detay = uygunsuzSebep.value;

 if(detay === "diger"){
  if(!uygunsuzDiger.value){
   showAlert({
    title:"Eksik Bilgi",
    message:"DiÄŸer sebebi yaz",
    buttons:[{text:"Tamam"}]
   });
   return;
  }
  detay = uygunsuzDiger.value;
 }

 saveInspection("uygunsuz", detay);
}
function callGuard(tc){
 db.ref(`projects/${proje}/guards/${tc}/telefon`).once("value",snap=>{
  if(!snap.exists() || !snap.val()){
   showAlert({
    title:"Telefon Yok",
    message:"Bu personelin kayÄ±tlÄ± telefonu yok",
    buttons:[{text:"Tamam"}]
   });
   return;
  }

  const tel = snap.val();

  showAlert({
   title:"Personel AransÄ±n mÄ±?",
   message:`ğŸ“ ${tel}`,
   buttons:[
    { text:"Ä°ptal" },
    { text:"Ara", onClick:()=>{ window.location.href=`tel:${tel}` } }
   ]
  });
 });
}
function toggleFlash(){
 if(!qrInstance) return;

 flashOn = !flashOn;

 qrInstance.applyVideoConstraints({
  advanced:[{ torch: flashOn }]
 }).catch(err=>{
  showAlert({
   title:"Flash Desteklenmiyor",
   message:"Bu cihaz flash kontrolÃ¼nÃ¼ desteklemiyor",
   buttons:[{text:"Tamam"}]
  });
 });
}
function refocusCamera(){
 if(!qrInstance) return;

 qrInstance.stop().then(()=>{
  qrInstance.start(
   { facingMode:"environment" },
   { fps:10, qrbox:250 },
   t=>{
    tcNo=t;
    qrInstance.stop();
    checkGuard();
   }
  );
 });
}
function openManual(){
 qrPage.classList.add("hidden");
 manualPage.classList.remove("hidden");
 manualTc.value = "";
 manualTc.focus();
}

function backToQr(){
 manualPage.classList.add("hidden");
 qrPage.classList.remove("hidden");
}

function manualSearch(){
 const tc = manualTc.value.trim();

 if(tc.length !== 11){
  showAlert({
   title:"GeÃ§ersiz TC",
   message:"11 haneli TC gir",
   buttons:[{text:"Tamam"}]
  });
  return;
 }

 tcNo = tc;
 manualPage.classList.add("hidden");
 checkGuard(); // QR okutmuÅŸ gibi devam eder
}
function backToProject(){

 // Devriye baÅŸlamÄ±ÅŸsa GERÄ° DÃ–NME
 if(aktifDevriyeId){
  showAlert({
   title:"Denetleme Devam Ediyor",
   message:`ğŸ“ ${projectTitle.innerText} projesi iÃ§in denetleme baÅŸlatÄ±ldÄ±.\n\nDenetlemeyi bitirmeden proje seÃ§imine dÃ¶nemezsiniz.`,
   buttons:[{text:"Tamam"}]
  });
  return;
 }

 // Devriye yoksa NORMAL GERÄ° DÃ–N
 listPage.classList.add("hidden");
 projectPage.classList.remove("hidden");
}

let cameraStream = null;
let cameraAllowed = false;


/* FOTO SEÃ‡ENEKLERÄ° */
function openPhotoOptions(){

 const hasPhoto = !!guard.photoBase64;

 showAlert({
  title:"Profil FotoÄŸrafÄ±",
  message: hasPhoto
   ? "Yeni profil fotoÄŸrafÄ± koymak ister misin?"
   : "Profil fotoÄŸrafÄ± eklemek ister misin?",
  buttons:[
   { text:"Ä°ptal" },
   {
    text: hasPhoto ? "Yeni Profil FotoÄŸrafÄ± Koy" : "Ekle",
    onClick: () => {
 cameraAllowed = true;
 openCameraForProfile();
}

   }
  ]
 });
}



function saveProfilePhoto(canvas, quality){

 const base64 = canvas.toDataURL("image/jpeg", quality);
 const sizeKB = Math.round((base64.length * 3) / 4 / 1024);

 if(sizeKB > 300 && quality > 0.2){
  return saveProfilePhoto(canvas, quality - 0.1);
 }

db.ref(`projects/${proje}/guards/${tcNo}`).update({
  photoBase64: base64
 }).then(()=>{

  guard.photoBase64 = base64;
  guardPhoto.src = base64;
  guardPhoto.style.display = "block";
  photoPlus.style.display = "none";
  showAlert({
   title:"BaÅŸarÄ±lÄ±",
   message:`Profil fotoÄŸrafÄ± kaydedildi (${sizeKB} KB)`,
   buttons:[{text:"Tamam"}]
  });
 });
}
function openCameraForProfile(){
 if(!cameraAllowed) return;
 cameraAllowed = false;

 // varsa Ã¶nce eski kamerayÄ± kapat
 if(cameraStream){
  cameraStream.getTracks().forEach(t=>t.stop());
  cameraStream = null;
 }

 navigator.mediaDevices.getUserMedia({
  video:{
   facingMode:{ ideal:"environment" } // âœ… ANDROID + IOS
  },
  audio:false
 }).then(stream=>{
  cameraStream = stream;
  camera.srcObject = stream;

  camera.onloadedmetadata = () => {
   camera.play();
  };

  cameraModal.classList.remove("hidden");
  cameraModal.style.display = "flex";
 }).catch(err=>{
  alert("Arka kamera aÃ§Ä±lamadÄ±");
  console.error(err);
 });
}



function captureProfilePhoto(){

 const vw = camera.videoWidth;
 const vh = camera.videoHeight;

 if(!vw || !vh){
  showAlert({
   title:"Kamera HazÄ±r DeÄŸil",
   message:"GÃ¶rÃ¼ntÃ¼ alÄ±namadÄ±",
   buttons:[{text:"Tamam"}]
  });
  return;
 }

 // ğŸ“ ekrandaki video boyutlarÄ±
 const displayW = camera.offsetWidth;
 const displayH = camera.offsetHeight;

 // ğŸ”² rehber boyutu (CSS'te verdiÄŸin deÄŸerle AYNI olmalÄ±)
 const guideSize = 220;

 // ğŸ¯ rehberin ekrandaki sol-Ã¼st koordinatÄ±
 const guideX = (displayW - guideSize) / 2;
 const guideY = (displayH - guideSize) / 2;

 // ğŸ”„ video â†’ gerÃ§ek piksel Ã¶lÃ§eÄŸi
 const scaleX = vw / displayW;
 const scaleY = vh / displayH;

 // ğŸ¯ rehberin videodaki gerÃ§ek karÅŸÄ±lÄ±ÄŸÄ±
 const sx = guideX * scaleX;
 const sy = guideY * scaleY;
 const sSize = guideSize * scaleX; // kare olduÄŸu iÃ§in tek Ã¶lÃ§ek yeterli

 // ğŸ–¼ï¸ canvas
 const canvas = document.createElement("canvas");
 canvas.width = sSize;
 canvas.height = sSize;

 const ctx = canvas.getContext("2d");
 ctx.drawImage(
  camera,
  sx, sy, sSize, sSize,
  0, 0, sSize, sSize
 );

 saveProfilePhoto(canvas, 0.85);
 closeCameraModal();
}
function closeCameraModal(){

 if(cameraStream){
  cameraStream.getTracks().forEach(t=>t.stop());
  cameraStream = null;
 }

 if(camera){
  camera.srcObject = null;
 }

 const modal = document.getElementById("cameraModal");
 if(modal){
  modal.classList.add("hidden");
  modal.style.display = "none";
 }
}

</script>
<div id="appAlert" class="hidden">
  <div class="alert-box">
    <h3 id="alertTitle"></h3>
    <p id="alertMessage"></p>
    <div id="alertActions"></div>
  </div>
</div>
<!-- ğŸ“¸ PROFÄ°L FOTO KAMERA MODALI -->
<div id="cameraModal" class="hidden"
 style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  align-items:center;
  justify-content:center;
  z-index:9999;
 ">

 <div style="position:relative;width:90%;max-width:360px;">

<video id="camera" autoplay playsinline
 style="width:100%;border-radius:16px;object-fit:contain">
</video>




  <!-- ğŸ”² KARE REHBER -->
  <div style="
   position:absolute;
   top:50%;
   left:50%;
   width:220px;
   height:220px;
   transform:translate(-50%,-50%);
   border:3px solid #00e5ff;
   border-radius:14px;
   box-shadow:0 0 0 2000px rgba(0,0,0,.55);
   pointer-events:none;
  "></div>

  <button onclick="captureProfilePhoto()" style="margin-top:14px;width:100%">
   ğŸ“¸ Profil FotoÄŸrafÄ± OluÅŸtur
  </button>

  <button onclick="closeCameraModal()"
   style="margin-top:8px;width:100%;background:#ff4d4d;color:#fff">
   âŒ Ä°ptal
  </button>

 </div>
</div>

</body>
</html>  
