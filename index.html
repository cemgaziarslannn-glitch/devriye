<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Denetleme Sistemi - Full</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<!-- QR Kod -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{margin:0;font-family:Arial;background:#0b1a27;color:#fff}
header{background:#081521;padding:15px;text-align:center}
section{padding:15px}
select,input,button{width:100%;padding:10px;margin-top:10px;border-radius:6px;border:none}
button{background:#1e88e5;color:#fff;font-weight:bold;cursor:pointer}
.card{background:#132b3f;padding:12px;border-radius:10px;margin-top:10px}
.badge{padding:4px 8px;border-radius:5px;font-size:12px}
.hidden{display:none}
img{width:100px;border-radius:8px;margin-top:5px}
</style>
</head>
<body>

<header>
<h2>Denetleme Sistemi - Full</h2>
</header>

<!-- Proje Seçimi -->
<section id="projectPage">
  <h3>Proje Seç</h3>
  <select id="projectSelect">
    <option value="">Proje seçiniz</option>
  </select>
  <button onclick="loadProject()">Projeyi Yükle</button>
</section>

<!-- Güvenlik Listesi -->
<section id="personelPage" class="hidden">
  <h3 id="projectTitle"></h3>
  <div id="personelList"></div>
  <button onclick="startInspection()">Denetlemeye Başla</button>
</section>

<!-- QR Okuma -->
<section id="qrPage" class="hidden">
  <h3>QR Kod Tara</h3>
  <div id="qr-reader" style="width:300px;"></div>
  <div id="qrStatus"></div>
</section>

<!-- Eksik Bilgi Ekranı -->
<section id="missingInfoPage" class="hidden">
  <h3>Eksik Bilgi</h3>
  <div id="missingFields"></div>
</section>

<!-- Bilgi Kartı -->
<section id="guardInfoPage" class="hidden">
  <h3>Güvenlik Kartı</h3>
  <img id="guardPhoto" src="" alt="Profil Foto">
  <div>Ad Soyad: <span id="infoAdSoyad"></span></div>
  <div>Kimlik Türü: <span id="infoKimlikTuru"></span></div>
  <div>Kart Geçerlilik: <span id="infoKartGecerlilik"></span></div>
  <div>Proje: <span id="infoProje"></span></div>
  <div>Silah Durumu: <span id="infoSilah"></span></div>
  <div id="denetimButtons" class="hidden">
    <button onclick="markInspection('gorevi_basinda')">Görevi Başında</button>
    <button onclick="markInspection('uyuyor')">Uyuyor</button>
    <button onclick="markInspection('uygunsuz')">Uygunsuz</button>
  </div>
</section>

<script>
// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCye0QlekBFonTxfeBIlhLc9ia-mleyfUM",
  authDomain: "denetleme-4d3d9.firebaseapp.com",
  projectId: "denetleme-4d3d9",
  storageBucket: "denetleme-4d3d9.appspot.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

// DOM
const projectSelect = document.getElementById("projectSelect");
const projectPage = document.getElementById("projectPage");
const personelPage = document.getElementById("personelPage");
const qrPage = document.getElementById("qrPage");
const missingInfoPage = document.getElementById("missingInfoPage");
const guardInfoPage = document.getElementById("guardInfoPage");
const missingFields = document.getElementById("missingFields");
const personelList = document.getElementById("personelList");

const infoAdSoyad = document.getElementById("infoAdSoyad");
const infoKimlikTuru = document.getElementById("infoKimlikTuru");
const infoKartGecerlilik = document.getElementById("infoKartGecerlilik");
const infoProje = document.getElementById("infoProje");
const infoSilah = document.getElementById("infoSilah");
const guardPhoto = document.getElementById("guardPhoto");
const denetimButtons = document.getElementById("denetimButtons");

let selectedProject = null;
let lastScannedQR = null;

// Projeleri çek
db.collection("projects").get().then(snapshot=>{
  snapshot.forEach(doc=>{
    const opt = document.createElement("option");
    opt.value = doc.id;
    opt.textContent = doc.data().projectName || "İsimsiz Proje";
    projectSelect.appendChild(opt);
  });
});

// Proje ve güvenlikleri yükle
function loadProject(){
  const pid = projectSelect.value;
  if(!pid) return alert("Proje seçiniz!");
  selectedProject = pid;
  personelList.innerHTML = "";

  db.collection("projects").doc(pid).get().then(doc=>{
    document.getElementById("projectTitle").innerText = "Proje: " + (doc.data().projectName || "İsimsiz Proje");
  });

  db.collection("projects").doc(pid).collection("guards").get().then(snapshot=>{
    snapshot.forEach(p=>{
      const d = p.data();
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `<div>${d.adSoyad || "İsimsiz"}</div>`;
      personelList.appendChild(card);
    });
  });

  projectPage.classList.add("hidden");
  personelPage.classList.remove("hidden");
}

// Denetlemeye başla → QR
function startInspection(){
  personelPage.classList.add("hidden");
  qrPage.classList.remove("hidden");
  const html5QrCode = new Html5Qrcode("qr-reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      lastScannedQR = decodedText;
      html5QrCode.stop();
      checkGuard(decodedText);
    },
    (errorMessage)=>{}
  );
}

// Guard kontrol + eksik bilgi kontrolü
function checkGuard(tc){
  db.collection("projects").doc(selectedProject).collection("guards").doc(tc).get()
  .then(doc=>{
    if(!doc.exists) return alert("Sistem kayıtlı değil!");
    const data = doc.data();
    let eksik = [];

    if(!data.profilFoto) eksik.push("Profil Fotoğrafı");
    if(!data.kimlikTuru) eksik.push("Kimlik Türü");
    if(!data.kimlikGecerlilik) eksik.push("Kimlik Geçerlilik Süresi");
    if(!data.silahDurumu) eksik.push("Silah Durumu / Türü");

    if(eksik.length>0){
      showMissingInfo(tc, eksik);
    } else {
      showGuardCard(tc, data);
    }
  });
}

// Eksik bilgi ekranı
function showMissingInfo(tc, eksik){
  qrPage.classList.add("hidden");
  guardInfoPage.classList.add("hidden");
  missingInfoPage.classList.remove("hidden");
  missingFields.innerHTML = "";

  eksik.forEach(field=>{
    const btn = document.createElement("button");
    btn.innerText = `Eksik: ${field} → Düzenle / Kaydet`;
    btn.onclick = ()=> fillMissingField(tc, field);
    missingFields.appendChild(btn);
  });
}

// Eksik alan doldurma
function fillMissingField(tc, field){
  missingFields.innerHTML = ""; // eski inputları temizle

  if(field === "Profil Fotoğrafı"){
    const fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.accept = "image/*";

    const saveBtn = document.createElement("button");
    saveBtn.innerText = "Kaydet";

    saveBtn.onclick = ()=>{
      const file = fileInput.files[0];
      if(!file) return alert("Lütfen bir dosya seçin!");
      const storageRef = storage.ref().child(`profile_photos/${tc}.jpg`);
      storageRef.put(file).then(()=>{
        storageRef.getDownloadURL().then(url=>{
          db.collection("projects").doc(selectedProject).collection("guards").doc(tc)
          .update({profilFoto: url})
          .then(()=>{
            alert("Profil fotoğrafı kaydedildi ✅");
            checkGuard(tc);
          });
        });
      });
    };

    missingFields.appendChild(fileInput);
    missingFields.appendChild(saveBtn);

  } else {
    const input = document.createElement("input");
    input.placeholder = field;

    const saveBtn = document.createElement("button");
    saveBtn.innerText = "Kaydet";

    saveBtn.onclick = ()=>{
      const value = input.value.trim();
      if(!value) return alert("Alan boş olamaz!");
      let updateObj = {};
      if(field === "Kimlik Türü") updateObj.kimlikTuru = value;
      if(field === "Kimlik Geçerlilik Süresi") updateObj.kimlikGecerlilik = value;
      if(field === "Silah Durumu / Türü") updateObj.silahDurumu = value;

      db.collection("projects").doc(selectedProject).collection("guards").doc(tc)
      .update(updateObj)
      .then(()=>{
        alert(`${field} kaydedildi ✅`);
        checkGuard(tc);
      });
    };

    missingFields.appendChild(input);
    missingFields.appendChild(saveBtn);
  }
}

// Guard kartı göster
function showGuardCard(tc, data){
  missingInfoPage.classList.add("hidden");
  qrPage.classList.add("hidden");
  guardInfoPage.classList.remove("hidden");

  guardPhoto.src = data.profilFoto || "";
  infoAdSoyad.innerText = data.adSoyad || "";
  infoKimlikTuru.innerText = data.kimlikTuru || "";
  infoKartGecerlilik.innerText = data.kimlikGecerlilik || "";
  infoProje.innerText = data.projectName || "";
  infoSilah.innerText = data.silahDurumu || "";

  denetimButtons.classList.remove("hidden");
}

// Denetim işaretleme
function markInspection(durum){
  db.collection("projects").doc(selectedProject).collection("guards")
    .doc(lastScannedQR).collection("denetimler").add({
      durum: durum,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{
      alert("Denetim kaydedildi: " + durum);
      guardInfoPage.classList.add("hidden");
      personelPage.classList.remove("hidden");
    });
}
</script>

</body>
</html>
