<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Denetleme Sistemi</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
:root{
 --bg:#070b16;
 --card:rgba(255,255,255,.08);
 --border:rgba(255,255,255,.18);
 --neon:#00e5ff;
 --neon2:#7c4dff;
}

*{box-sizing:border-box}

body{
 margin:0;
 font-family:'Segoe UI',Arial;
 background:radial-gradient(circle at top,#0e1b3d,#050812 60%);
 color:#fff;
 min-height:100vh;
}

section{
 padding:24px;
 animation:fade .35s ease;
}

.hidden{display:none}

h2{text-align:center}

select,input,button{
 width:100%;
 padding:14px;
 margin-top:12px;
 border-radius:14px;
 border:1px solid var(--border);
 background:var(--card);
 color:#fff;
 font-size:15px;
 backdrop-filter:blur(10px);
}

button{
 cursor:pointer;
 background:linear-gradient(135deg,var(--neon),var(--neon2));
 border:none;
 font-weight:700;
 box-shadow:0 10px 30px rgba(0,229,255,.35);
 transition:.3s;
}

button:hover{
 transform:translateY(-2px);
 box-shadow:0 18px 40px rgba(124,77,255,.5);
}

.list-item{
 padding:14px;
 margin:10px 0;
 background:var(--card);
 border-radius:16px;
 border:1px solid var(--border);
}

.card{
 max-width:380px;
 margin:auto;
 background:linear-gradient(160deg,#1b2a4e,#0a1024);
 border-radius:22px;
 padding:26px;
 box-shadow:0 30px 60px rgba(0,0,0,.7);
 border:1px solid rgba(255,255,255,.2);
}

.card::before{
 content:"T.C. GÃœVENLÄ°K KARTI";
 position:absolute;
 margin-top:-14px;
 font-size:11px;
 opacity:.5;
}

.row{
 display:flex;
 justify-content:space-between;
 margin:10px 0;
 font-size:14px;
}

.label{opacity:.6}
.value{font-weight:600}

.status{
 margin-top:18px;
 padding:10px;
 text-align:center;
 border-radius:12px;
 background:rgba(0,229,255,.12);
 border:1px solid rgba(0,229,255,.4);
 color:#00e5ff;
 font-weight:700;
}

hr{
 border:0;
 height:1px;
 background:linear-gradient(to right,transparent,var(--neon),transparent);
 margin:22px 0;
}

#qr-reader{
 margin:auto;
 border-radius:18px;
 overflow:hidden;
 box-shadow:0 25px 50px rgba(0,0,0,.7);
}

@keyframes fade{
 from{opacity:0;transform:translateY(20px)}
 to{opacity:1;transform:none}
}
</style>
</head>
<body>

<!-- PROJE -->
<section id="projectPage">
<h2>ğŸ“ Proje SeÃ§</h2>
<select id="projectSelect"></select>
<button onclick="loadProject()">Devam</button>
</section>

<!-- LÄ°STE -->
<section id="listPage" class="hidden">
<h2 id="projectTitle"></h2>
<div id="guardList"></div>
<button onclick="startQR()">ğŸš€ Denetlemeye BaÅŸla</button>
</section>

<!-- QR -->
<section id="qrPage" class="hidden">
<h2>ğŸ“· QR Kod Okut</h2>
<div id="qr-reader" style="width:320px"></div>
</section>

<!-- ZORUNLU -->
<section id="formPage" class="hidden">
<h2>âš ï¸ Zorunlu Bilgiler</h2>
<input id="telefon" placeholder="Telefon">
<select id="kimlikTuru">
<option value="">Kimlik TÃ¼rÃ¼</option>
<option>SilahlÄ±</option>
<option>SilahsÄ±z</option>
</select>
<input type="date" id="kimlikGecerlilik">
<button onclick="saveRequired()">Kaydet</button>
</section>

<!-- KART -->
<section id="cardPage" class="hidden">
<div class="card">

<h2 id="ad"></h2>

<div class="row">
 <div class="label">TC</div>
 <div class="value" id="tc"></div>
</div>

<div class="row">
 <div class="label">Kimlik TÃ¼rÃ¼</div>
 <div class="value" id="kimlik"></div>
</div>

<div class="row">
 <div class="label">GeÃ§erlilik</div>
 <div class="value" id="gecerlilik"></div>
</div>

<div class="status">AKTÄ°F PERSONEL</div>

<hr>

<div id="actionButtons">
 <button onclick="markDone()">âœ… GÃ¶revi BaÅŸÄ±nda</button>
 <button onclick="saveInspection('uyuyor')">ğŸ˜´ Uyuyor</button>
 <button onclick="saveInspection('uygunsuz')">âš ï¸ Uygunsuz</button>
</div>

<div id="afterDone" class="hidden">
 <button onclick="startQR()">ğŸ” DiÄŸer Personeli Denetle</button>
 <button onclick="finish()">ğŸ Devriyeyi Bitir</button>
</div>

</div>
</section>

<script>
const firebaseConfig={
 apiKey:"AIzaSyCye0QlekBFonTxfeBIlhLc9ia-mleyfUM",
 authDomain:"denetleme-4d3d9.firebaseapp.com",
 databaseURL:"https://denetleme-4d3d9-default-rtdb.firebaseio.com",
 projectId:"denetleme-4d3d9"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let proje="",tcNo="",guard={};
const qr=new Html5Qrcode("qr-reader");

/* PROJELER */
db.ref("projects").once("value",s=>{
 projectSelect.innerHTML="<option value=''>SeÃ§</option>";
 s.forEach(p=>{
  projectSelect.innerHTML+=`<option value="${p.key}">${p.val().projectName}</option>`;
 });
});

function loadProject(){
 proje=projectSelect.value;
 projectPage.classList.add("hidden");
 listPage.classList.remove("hidden");

 db.ref(`projects/${proje}`).once("value",s=>{
  projectTitle.innerText=s.val().projectName;
 });

 db.ref(`projects/${proje}/guards`).once("value",s=>{
  guardList.innerHTML="";
  s.forEach(g=>{
   guardList.innerHTML+=`<div class="list-item">${g.val().adSoyad}</div>`;
  });
 });
}

function startQR(){
 listPage.classList.add("hidden");
 cardPage.classList.add("hidden");
 qrPage.classList.remove("hidden");

 qr.start({facingMode:"environment"},{fps:10,qrbox:250},t=>{
  tcNo=t;
  qr.stop();
  loadGuard();
 });
}

function loadGuard(){
 db.ref(`projects/${proje}/guards/${tcNo}`).once("value",s=>{
  guard=s.val();
  qrPage.classList.add("hidden");

  (!guard.telefon||!guard.kimlikTuru||!guard.kimlikGecerlilik)
  ? formPage.classList.remove("hidden")
  : showCard();
 });
}

function saveRequired(){
 if(!telefon.value||!kimlikTuru.value||!kimlikGecerlilik.value){
  alert("TÃ¼m alanlar zorunlu");
  return;
 }
 db.ref(`projects/${proje}/guards/${tcNo}`).update({
  telefon:telefon.value,
  kimlikTuru:kimlikTuru.value,
  kimlikGecerlilik:kimlikGecerlilik.value
 }).then(loadGuard);
}

function showCard(){
 formPage.classList.add("hidden");
 cardPage.classList.remove("hidden");

 ad.innerText=guard.adSoyad;
 tc.innerText=guard.tc;
 kimlik.innerText=guard.kimlikTuru;
 gecerlilik.innerText=guard.kimlikGecerlilik;

 document.getElementById("actionButtons").classList.remove("hidden");
 document.getElementById("afterDone").classList.add("hidden");
}

function markDone(){
 db.ref(`denetimler/${proje}`).push({
  tc:tcNo,
  durum:"gorevi_basinda",
  tarih:Date.now()
 }).then(()=>{
  document.getElementById("actionButtons").classList.add("hidden");
  document.getElementById("afterDone").classList.remove("hidden");
 });
}

function saveInspection(d){
 db.ref(`denetimler/${proje}`).push({
  tc:tcNo,
  durum:d,
  tarih:Date.now()
 }).then(()=>{
  document.getElementById("actionButtons").classList.add("hidden");
  document.getElementById("afterDone").classList.remove("hidden");
 });
}

function finish(){
 alert("Devriye tamamlandÄ±");
 location.reload();
}
</script>

</body>
</html>
